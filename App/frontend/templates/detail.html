{% extends "base.html" %}

{% block title %}Detail Movie{% endblock %}

{% block content %}
<section class="section-detail-movie">
    <div class="box-detail"></div>
    <div class="detail-video">
        <iframe class="main-video" id="trailer-player" src="" frameborder="0" allowfullscreen
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; "
            style="width: 100%; height: 400px;">
        </iframe>
        <p style="font-weight: bold;margin-bottom: -10px;font-size: 20px;">Summary</p>
        <p class="summary">
        </p>

    </div>
    <div class="detail-rating">
      <h2 class="detail-movie-title"></h2>
      <div class="detail-underline"></div>
      <div class="meta-label">METASCORE</div>
      <div class="score-container">
        <div class="score-info">
          <div class="score-description"></div>
          <div class="score-details">Based on 20 Critic Reviews</div>
        </div>
        <div class="score-box">10</div>
      </div>
      <div class="rating-bar">
        <div class="positive-bar"></div>
        <div class="mixed-bar"></div>
        <div class="negative-bar"></div>
      </div>
      <div class="detail-genre">
        <p style="color:gray;letter-spacing: 1px;">Genre</p>
        <div class="movie-genre-container">


        </div>
      </div>
      <div class="detail-myscore">
        <p style="color:gray; letter-spacing: 1px; margin-bottom: 5px;">MY SCORE</p>
        <div class="circle-score">3</div>
        <div class="score-description">Generally Favorable</div>
        <div class="myscore-bar">
          <div class="piece-score-bar piece-0"></div>
          <div class="piece-score-bar piece-1"></div>
          <div class="piece-score-bar piece-2"></div>
          <div class="piece-score-bar piece-3"></div>
          <div class="piece-score-bar piece-4"></div>
          <div class="piece-score-bar piece-5"></div>
          <div class="piece-score-bar piece-6"></div>
          <div class="piece-score-bar piece-7"></div>
          <div class="piece-score-bar piece-8"></div>
          <div class="piece-score-bar piece-9"></div>
          <div class="piece-score-bar piece-10"></div>
        </div>
        <div class="post-myreview">
          <a href="#">Edit My Review</a>
        </div>
      </div>
    </div>
</section>
<section class="section-user-reviews">
    <div class="featured-title-group">
        <h2 class="section-title">User Reviews</h2>
        <div class="featured-underline featured-underline-1"></div>
    </div>
    <div class="list-comment">
        <div class="comment">
            <div class="score-box score-comment">71</div>
            <h3>Trailer Nilou</h3>
            <div class="date-comment">Jul,3,2025</div>
            <p class="comment-text" style="grid-area: comment;">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
            <a href="#" class="read-more" style="grid-area: read;"><p>Read more</p></a>
            <div class="detail-underline" style="grid-area: line"></div>
            <p class="user-name" style="grid-area:user">By Văn Đạo</p>
        </div>
        <div class="comment">
            <div class="score-box score-comment">71</div>
            <h3>Trailer Nilou</h3>
            <div class="date-comment">Jul,3,2025</div>
            <p class="comment-text" style="grid-area: comment;">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
            <a href="#" class="read-more" style="grid-area: read;"><p>Read more</p></a>
            <div class="detail-underline" style="grid-area: line"></div>
            <p class="user-name" style="grid-area:user">By Văn Đạo</p>
        </div>
    </div>
    <div class="review-all">
        <a href="#" class="btn btn-review">See All 51 User Reviews</a>
    </div>
</section>
<!-- <section class="section">
  <div class="section-header">
    <div class="featured-title-group">
      <h2 class="section-title">Related Movies</h2>
      <div class="featured-underline"></div>
    </div>
    <div class="navigation-arrows">
      <div class="arrow arrow-left" data-target="related-grid">
        <img src="/static/img/arrow left.png" alt="Previous">
      </div>
      <div class="arrow arrow-right" data-target="related-grid">
        <img src="/static/img/arrow right.png" alt="Next">
      </div>
    </div>
  </div>

  <div class="movie-list-container">
    <div class="movie-list-small" id="related-grid">

  </div>
</section> -->




<!-- <div id="reviewModal" class="modal">
  <div class="modal-content">

    <span class="close-btn">&times;</span>

    <h3 class="modal-title">Add My Review</h3>


    <div class="movie-info">
      <img src="/static/img/flash.jpg" alt="Poster">
      <div class="movie-meta">
        <strong>Jurassic World Rebirth</strong>
        <p>Release Date : Jul 2, 2025</p>
      </div>
    </div>


    <div class="myscore-section">
      <div class="score-circle">7</div>
      <div class="score-text">
        <p>MY SCORE</p>
        <strong>Generally Favorable</strong>
        <div class="score-bar">
          <span class="bar active"></span><span class="bar active"></span><span class="bar active"></span>
          <span class="bar active"></span><span class="bar active"></span><span class="bar"></span>
          <span class="bar"></span><span class="bar"></span><span class="bar"></span><span class="bar"></span>
        </div>
      </div>
    </div>

    <form class="review-form">
      <label>Write a review for <strong>Jurassic World Rebirth</strong></label>
      <textarea placeholder="Minimum 75 characters" maxlength="5000"></textarea>
      <div class="char-count">5000 Characters remaining</div>

      <div class="modal-buttons">
        <button type="button" class="btn cancel">Cancel</button>
        <button type="submit" class="btn post">Post</button>
      </div>
    </form>
  </div>
</div> -->
<script src="https://www.youtube.com/iframe_api"></script>
<script>
let player;
let watchStartTime = null;      // Thời điểm bắt đầu xem (mỗi lần Play)
let totalWatchTime = 0;         // Tổng thời gian đã xem (cộng dồn)
let isPlaying = false;

document.addEventListener('DOMContentLoaded', function () {
    const movieId = extractMovieIdFromURL();
    const startTime = Date.now();

    // Gửi dwelltime khi rời trang
    window.addEventListener('beforeunload', function () {
        const dwellTime = Date.now() - startTime;
        if (!movieId) return;

        logUserEvent({
            action_type: "dwelltime",
            movie_id: movieId,
            dwell_time: dwellTime,
            timestamp: new Date().toISOString(),
            user_agent: navigator.userAgent
        });

        // Nếu đang xem mà tắt trang → ghi nốt thời gian đã xem
        if (isPlaying && watchStartTime) {
            totalWatchTime += Math.floor((Date.now() - watchStartTime) / 1000);
            logUserEvent({
                action_type: "trailer",
                event: "left_page",
                movie_id: movieId,
                watch_seconds: totalWatchTime,
                timestamp: new Date().toISOString(),
                user_agent: navigator.userAgent
            });
        }
    });
});

// ✅ Hàm YouTube API gọi khi sẵn sàng
function onYouTubeIframeAPIReady() {
    console.log("✅ YouTube API ready, waiting for iframe to load…");

}

// ✅ Lắng nghe trạng thái video
function onPlayerStateChange(event) {
    const movieId = extractMovieIdFromURL();
    if (!movieId) return;

    const state = event.data;

    if (state === YT.PlayerState.PLAYING) {
        if (!isPlaying) {
            watchStartTime = Date.now();
            isPlaying = true;

            logUserEvent({
                action_type: "trailer",
                event: "started",
                movie_id: movieId,
                timestamp: new Date().toISOString(),
                user_agent: navigator.userAgent
            });
        }
    }

    if (state === YT.PlayerState.PAUSED && isPlaying) {
        // Cộng dồn thời gian xem
        totalWatchTime += Math.floor((Date.now() - watchStartTime) / 1000);
        isPlaying = false;

        logUserEvent({
            action_type: "trailer",
            event: "paused",
            movie_id: movieId,
            watch_seconds: totalWatchTime,
            timestamp: new Date().toISOString(),
            user_agent: navigator.userAgent
        });
    }

    if (state === YT.PlayerState.ENDED) {
        // Khi video kết thúc, cộng nốt thời gian và gửi log
        if (isPlaying) {
            totalWatchTime += Math.floor((Date.now() - watchStartTime) / 1000);
            isPlaying = false;
        }

        logUserEvent({
            action_type: "trailer",
            event: "finished",
            movie_id: movieId,
            watch_seconds: totalWatchTime,
            timestamp: new Date().toISOString(),
            user_agent: navigator.userAgent
        });

        // Reset để lần xem sau bắt đầu lại từ 0
        totalWatchTime = 0;
    }
}

// ✅ Gửi log về backend (backend push Kafka)
function logUserEvent(logData) {
    fetch('http://127.0.0.1:5000/api/v1/log/user_event', {
        method: 'POST',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(logData)
    }).catch(console.warn);
}

// ✅ Lấy movie_id từ URL (?movie_id=xxx)
function extractMovieIdFromURL() {
    const url = new URL(window.location.href);
    const id = url.searchParams.get("movie_id");
    return id ? parseInt(id) : null;
}
</script>


{% endblock %}
